// DON'T EDIT THIS FILE. IT IS GENERATED BY HEAVEN PACKAGE.

pub struct Receiver {
  buffer : Buffer
  listener_map : Map[String, (Json) -> Unit]
}

pub fn get_context() ->
     (
       (String, (Json) -> Unit) -> Unit,
       (String, Json) -> Unit,
       (String, Json, (Json) -> Unit) -> Unit,
     ) {
  (listen_event, send_event, call_event)
}

pub fn call_event(
  event_name : String,
  data : Json,
  callback : (Json) -> Unit
) -> Unit {
  let id = receiver.listener_map.keys().count().to_string()
  listen_event(
    id,
    fn(data) {
      callback(data)
      receiver.listener_map.remove(id)
    },
  )
  [String(event_name), data, String(id)] |> send
}

pub fn h_sd(data : Int) = "__h" "h_sd"

pub fn h_se() = "__h" "h_se"

let receiver : Receiver = { buffer: Buffer::new(), listener_map: Map::new() }

pub fn h_rd(data : Int) -> Unit {
  if data != 0 {
    receiver.buffer.write_char(Char::from_int(data))
  }
}

pub fn h_re() -> Unit {
  let message = receiver.buffer.to_string()
  match @json.parse?(message) {
    Ok([String(event_name), event_data]) =>
      match event_name {
        _ =>
          match receiver.listener_map[event_name] {
            Some(listener) => listener(event_data)
            None => println("No listener for event type: " + event_name)
          }
      }
    Ok(json) => println("type and data not found in \{json}")
    Err(e) => println("Error parsing JSON: \{e}")
  }
  receiver.buffer.reset()
}

pub fn listen_event(event_name : String, callback : (Json) -> Unit) -> Unit {
  receiver.listener_map[event_name] = callback
}

pub fn send_event(event_name : String, event_data : Json) -> Unit {
  [String(event_name), event_data] |> send
}

fn send(body : Json) -> Unit {
  let chars = @json.stringify(body).to_array().map(fn(c) { c.to_int() })
  chars.each(fn(c) { h_sd(c) })
  h_se()
}

pub fn addEventListener(
  objectName : String,
  eventName : String,
  callback : (Json) -> Unit
) -> Unit {
  ignore(
    send_event(
      "\{objectName}.addEventListener",
      [String(eventName), String("\{objectName}.\{eventName}")],
    ),
  )
  listen_event("\{objectName}.\{eventName}", callback)
}
